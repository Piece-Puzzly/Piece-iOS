default_platform(:ios)
Dotenv.load

platform :ios do

  desc "xcconfig íŒŒì¼ì˜ ë¹Œë“œ ë„˜ë²„ ì—…ë°ì´íŠ¸"
  private_lane :update_xcconfig_build_number do |options|
    build_number = options[:build_number]
    
    ["../Debug.xcconfig", "../Release.xcconfig"].each do |config_file|
      next unless File.exist?(config_file)
      
      content = File.read(config_file)
      updated_content = content.gsub(/APP_BUILD = \d+/, "APP_BUILD = #{build_number}")
      File.write(config_file, updated_content)
      puts "âœ… #{config_file} APP_BUILD updated to: #{build_number}"
    end
  end

  # before_all: Laneì´ ì‹œì‘ë˜ê¸° ì „ 1íšŒ ìˆ˜í–‰ë˜ëŠ” LifeCycle
  before_all do 
    clean_build_artifacts

    # 0. ë¹Œë“œ ë„˜ë²„ ê°€ì ¸ì˜¤ê¸° (= ë©”ì¸ ë¸Œëœì¹˜ì˜ ì»¤ë°‹ ê°œìˆ˜)
    build_number = sh("git rev-list --count origin/main").strip.to_i

    # 1. ë¹Œë“œ ë„˜ë²„ ì—…ë°ì´íŠ¸
    update_xcconfig_build_number(build_number: build_number)
  
    # 2. Tuist í”„ë¡œì íŠ¸ ìƒì„± (xcconfig ë°˜ì˜ í›„ ë¹Œë“œ)
    sh("cd .. && tuist generate")
    
    # 3. ë²„ì „ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ë° ë¹Œë“œ ë„ˆë²„ ì—…ë°ì´íŠ¸
    lane_context[:VERSION_NUMBER] = get_version_number(xcodeproj: "App/Piece-iOS.xcodeproj")
    lane_context[:BUILD_NUMBER] = build_number
  end
  
  # 4. ì•±ìŠ¤í† ì–´ ì»¤ë„¥íŠ¸ API í‚¤ ê°€ì ¸ì˜¤ê¸°
  private_lane :fetch_api_key do
    app_store_connect_api_key(
      key_id: ENV['ASC_KEY_ID'],
      issuer_id: ENV['ASC_ISSUER_ID'],
      key_filepath: ENV['ASC_KEY_FILEPATH'],
      duration: 1200,
      in_house: false,
    )
  end

  desc "Beta ë²„ì „ ë¹Œë“œ - TestFlight"
  lane :beta do
    build(is_deploy: false)

    api_key = fetch_api_key

    upload_to_testflight(
      api_key: api_key,
      app_identifier: ENV['APP_IDENTIFIER'],
      team_id: ENV['TEAM_ID']
    )
  end

  desc "Release ë²„ì „ ë¹Œë“œ - App Store ë°°í¬"
  lane :deploy do
    build(is_deploy: true)

    api_key = fetch_api_key

    upload_to_app_store(
      submit_for_review: true,
      force: true,
      team_id: ENV['TEAM_ID'],
      automatic_release: false,
      skip_screenshots: true,
      skip_metadata: true,
      precheck_include_in_app_purchases: false
    )
  end

  desc "ì•± ë¹Œë“œ"
  private_lane :build do |options|
    # provisioning = options[:is_deploy] ? "Puzzly_Distribution" : "Puzzly_Adhoc"
    provisioning = "Puzzly_Distribution"

    # export_method = options[:is_deploy] ? "app-store" : "ad-hoc"
    export_method = "app-store"
    type = options[:is_deploy] ? "release" : "beta"

    # note = File.read("./metadata/ko/release_notes.txt")
    note = "âœ… TestFlight ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸"

    notify_discord(
      type: type,
      step: "start",
      note: note,
    )

    build_app(
      workspace: "Piece-iOS.xcworkspace",
      output_directory: "./fastlane/Output",
      scheme: "Piece-iOS-Release",
      configuration: "Release",
      export_method: export_method,
      export_options: {
        provisioningProfiles: {
          "com.puzzly.piece" => provisioning
        }
      }
    )
  end

  desc "Discord ì•Œë¦¼ ì „ì†¡"
  private_lane :notify_discord do |options|
    type = options[:type] || "beta" # "beta", "release"
    step = options[:step] || "start" # "start", "success"
    note = options[:note]
    # title = "âœ… í…ŒìŠ¤íŠ¸ í”Œë¼ì´íŠ¸ ì—…ë¡œë“œ ì„±ê³µ"
    version = lane_context[:VERSION_NUMBER]
    build = lane_context[:BUILD_NUMBER]
    
    message = case [type, step]
            when ["beta", "start"]
              "ğŸƒâ€â™‚ï¸ **TestFlight ë¹Œë“œ ì‹œì‘**\n\n**ë²„ì „**: #{version}(#{build})\n**ìƒíƒœ**: ë² íƒ€ í…ŒìŠ¤íŠ¸ìš© ë¹Œë“œë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤..."
            when ["beta", "success"]
              "ğŸš€ **ìƒˆë¡œìš´ TestFlight ë¹Œë“œ ë°°í¬ ì™„ë£Œ!**\n**ë²„ì „**: #{version}\n**ë¹Œë“œ**: #{build}\n**ìƒíƒœ**: TestFlight ì—…ë¡œë“œ ì„±ê³µ âœ…\n\nìƒˆë¡œìš´ ë² íƒ€ ë¹Œë“œê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤! í™•ì¸í•´ì£¼ì„¸ìš”."
            when ["release", "start"]
              "ğŸ¯ **App Store ë°°í¬ ì‹œì‘**\n\n**ë²„ì „**: #{version}(#{build})\n**ìƒíƒœ**: ì •ì‹ ë¦´ë¦¬ì¦ˆìš© ë¹Œë“œë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤..."
            when ["release", "success"]
              "ğŸ‰ **App Store ë°°í¬ ì™„ë£Œ!**\n**ë²„ì „**: #{version}\n**ë¹Œë“œ**: #{build}\n**ìƒíƒœ**: App Store ì œì¶œ ì„±ê³µ âœ…\n\nì •ì‹ ë²„ì „ì´ App Storeì— ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤! ì‹¬ì‚¬ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."
            else
              "ğŸ“± **ë¹Œë“œ ì•Œë¦¼**\në²„ì „: #{version}(#{build})\nìƒíƒœ: #{step}"
            end
    
    discord_webhook_url = ENV['DISCORD_URL']
    discord_notifier(
      webhook_url: discord_webhook_url,
      title: note ? "[ë³€ê²½ì‚¬í•­]" : nil,
      description: message,
    )
  end

  after_all do |lane|
    type = case lane
            when :beta then "beta"
            when :deploy then "release"
            else "other"
            end
    note = "âœ… TestFlight ì—…ë¡œë“œ ì™„ë£Œ í…ŒìŠ¤íŠ¸"
    # ì—¬ê¸° ì•„ë§ˆ nilë¡œ ë“¤ì–´ê°€ì•¼ë¨
    notify_discord(
      type: type, 
      step: "success",
      note: note
    )

    clean_build_artifacts
  end

    error do |_, exception|
    discord_webhook_url = ENV['DISCORD_URL']
    title = "âŒ í…ŒìŠ¤íŠ¸ í”Œë¼ì´íŠ¸ ì—…ë¡œë“œ ì‹¤íŒ¨"
    message = exception.message
    
    discord_notifier(
      webhook_url: discord_webhook_url,
      title: title,
      description: message,
      success: false
    )
  end

end